"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();exports.__esModule=!0;var fs=require("fs"),SiteAPI=require("./siteapi"),extract=require("extract-zip");global.srclocation=__dirname;var PluginManager=function(){function t(){this.plugins=[],this.api=new ServerApi}return t.prototype.loadPlugins=function(t){fs.existsSync(t)||fs.mkdirSync(t);for(var e=0,i=this.getPlugins(t);e<i.length;e++){var n=i[e];this.plugins.push(this.loadPlugin(t,n))}},t.prototype.loadPlugin=function(t,e){var i=this.getPluginDescription(t,e),n=i.name,r=i.url,s=i.author,o=i.author_url,p=i.version,u=i.main;return new(require(t+"/"+e+"/"+u).default)(n,r,s,o,p,u)},t.prototype.setupPlugins=function(){this.api.addFile(__dirname+"/../jquery/jquery.js"),this.api.addScript(__dirname+"/../jquery/jquery.min.js"),this.api.addFile(__dirname+"/../jquery/jquery.min.js.map"),this.api.addScript(__dirname+"/htdocs/scripts/prototypes-min.js"),this.api.addScript(__dirname+"/htdocs/scripts/ajax-min.js"),this.api.addScript(__dirname+"/htdocs/scripts/setupWindow-min.js"),this.api.addStylesheet(__dirname+"/htdocs/style/style.min.css");for(var t=0,e=this.plugins;t<e.length;t++){e[t].setup(this.api)}this.api.registerListener(new OnRequest(this.api))},t.prototype.startPlugins=function(){for(var t=0,e=this.plugins;t<e.length;t++){e[t].start(this.api)}},t.prototype.stopPlugins=function(){for(var t=0,e=this.plugins;t<e.length;t++){e[t].stop(this.api)}},t.prototype.reloadPlugins=function(){for(var t=0,e=this.plugins;t<e.length;t++){e[t].reload(this.api)}},t.prototype.getPluginDescription=function(t,e){return JSON.parse(fs.readFileSync(t+"/"+e+"/plugin.json").toString())},t.prototype.getPlugins=function(t){for(var e=[],i=0,n=fs.readdirSync(t);i<n.length;i++){var r=n[i];fs.lstatSync(t+"/"+r).isDirectory()&&e.push(r)}return e},t.prototype.fireEvent=function(t){return this.api.fireEvent(t)},t.prototype.installPlugin=function(t,r){var s=this;SiteAPI.loadSite(SiteAPI.parseURL(t),function(i){if(i=JSON.parse(i),!fs.existsSync(r+"/"+i.name)){var n=r+"/"+i.name+".tmp.zip";SiteAPI.downloadFile(n,i.versions[i.newestversion],function(){extract(n,{dir:r+"/"+i.name},function(t){if(t)console.log(t);else{var e=s.loadPlugin(r,i.name);e.setup(s.api),e.start(s.api),s.plugins.push(e),fs.unlinkSync(n)}})})}})},t}();exports.PluginManager=PluginManager;var ServerApi=function(){function t(){this.listeners=[],this.scripts={},this.stylesheets={},this.files={},this.apis={}}return t.prototype.on=function(t,e){this.registerListener(new OnListener(t,e))},t.prototype.registerListener=function(t){this.listeners.push(t)},t.prototype.fireEvent=function(t){for(var e=t.getType(),i=0,n=this.listeners;i<n.length;i++){var r=n[i];r.getType()==e&&r.run(t)}return t},t.prototype.addScript=function(t,e){return void 0===e&&(e="/"+guid()+".js"),this.scripts[e]=t,e},t.prototype.addStylesheet=function(t,e){return void 0===e&&(e="/"+guid()+".css"),this.stylesheets[e]=t,e},t.prototype.addFile=function(t,e){return void 0===e&&(e=null),null==e&&(e="/"+guid()+"."+t.split(".")[t.split(".").length-1]),this.files[e]=t,e},t.prototype.registerAPI=function(t,e){this.apis[t]=e},t.prototype.getAPI=function(t){return this.apis[t]},t}();exports.ServerApi=ServerApi;var Plugin=function(t,e,i,n,r,s){this.name=t,this.url=e,this.author=i,this.author_url=n,this.version=r,this.main=s};exports.Plugin=Plugin;var RequestEvent=function(){function t(t,e){this.canceled=!1,this.request=t,this.response=e}return t.prototype.getType=function(){return"request"},t.prototype.cancel=function(){this.canceled=!0},t}();exports.RequestEvent=RequestEvent;var OnListener=function(){function t(t,e){this.trigger=t,this.func=e}return t.prototype.run=function(t){this.func(t)},t.prototype.getType=function(){return this.trigger},t}();exports.OnListener=OnListener;var RequestListener=function(){function t(){}return t.prototype.getType=function(){return"request"},t}();function guid(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}exports.RequestListener=RequestListener;var contenttypes=JSON.parse(fs.readFileSync(__dirname+"/contenttypes.json").toString()),OnRequest=function(i){function t(t){var e=i.call(this)||this;return e.api=t,e}return __extends(t,i),t.prototype.run=function(t){var e=t.request.url;if("/"==e.charAt(e.length-1)&&(e+="index.html"),"/index.html"==e){var i="";for(var n in this.api.scripts)i+='<script src="'+n+'"><\/script>';for(var n in this.api.stylesheets)i+='<link type="text/css" rel="stylesheet" href="'+n+'">';t.response.writeHead(200,{"Content-Type":"text/html"}),t.response.end(fs.readFileSync(__dirname+"/htdocs/index.html").toString().replace(/%scriptplaceholder%/g,i)),t.cancel()}for(var r in this.api.scripts)t.request.url==r&&(t.response.writeHead(200,{"Content-Type":"text/javascript"}),t.response.end(fs.readFileSync(this.api.scripts[r])),t.cancel());for(var r in this.api.stylesheets)t.request.url==r&&(t.response.writeHead(200,{"Content-Type":"text/css"}),t.response.end(fs.readFileSync(this.api.stylesheets[r])),t.cancel());for(var r in this.api.files)if(t.request.url==r){var s=this.api.files[r],o=s.split(".")[s.split(".").length-1],p="text/html";contenttypes[o]&&(p=contenttypes[o]),t.response.writeHead(200,{"Content-Type":p}),t.response.end(fs.readFileSync(this.api.files[r])),t.cancel()}},t}(RequestListener);exports.default=PluginManager;