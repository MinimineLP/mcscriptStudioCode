#!/usr/bin/env node
"use strict";exports.__esModule=!0;var http=require("http"),fs=require("fs"),path=require("path"),server_1=require("./server");exports.ServerSideApplication=server_1.default;var PluginManager_1=require("./PluginManager");exports.PluginManager=PluginManager_1.PluginManager,exports.RequestEvent=PluginManager_1.RequestEvent;var SiteAPI=require("./siteapi");function createServer(e,r){void 0===e&&(e="."),void 0===r&&(r=!0);var a=new PluginManager_1.PluginManager;r&&(a.loadPlugins(__dirname+"/../plugins"),a.setupPlugins(),a.startPlugins(),SiteAPI.loadSite({host:"raw.githubusercontent.com",path:"/MinimineLP/MCScriptStudioCode-core-plugins/master/plugins-core.json",protocoll:"https"},function(e){for(var r=0,t=JSON.parse(e);r<t.length;r++){var n=t[r];a.installPlugin(n,__dirname+"/../plugins")}}));var s=__dirname+"/htdocs",o=new server_1.default(fs.realpathSync(e)),l=JSON.parse(fs.readFileSync(__dirname+"/contenttypes.json").toString());return{server:http.createServer(function(e,t){if(e.url=e.url.split("#")[0].split("?")[0],!a.fireEvent(new PluginManager_1.RequestEvent(e,t)).canceled)if("/"==e.url.charAt(e.url.length-1)&&(e.url+="index.html"),console.log('request starting by address "'+e.connection.remoteAddress+'": '+e.url+"..."),"/server"!=e.url){var n=s+e.url;"./"==n&&(n="./index.html");var r=path.extname(n),i="text/html";l[r]&&(i=l[r]),fs.readFile(n,function(e,r){e?"ENOENT"==e.code?fs.readFile(s+"/404.html",function(e,r){e&&console.log("Error reading 404 file (code: "+e.code+") "+e),t.writeHead(200,{"Content-Type":i}),t.end(r,"utf-8")}):(t.writeHead(500),t.end("Sorry, check with the site admin for error: "+e.code+" ..\n"),console.log("Error occured while reading files from fs ("+n+") (code: "+e.code+") "+e),t.end()):(t.writeHead(200,{"Content-Type":i}),t.end(r,"utf-8"))})}else o.execRequest(e,t)}),manager:a}}function startServer(e,r,t){void 0===e&&(e="."),void 0===r&&(r=80),void 0===t&&(t=!0);var n=createServer(e,t);return n.server.listen(r),n}exports.SiteAPI=SiteAPI,exports.default=startServer,exports.createServer=createServer,exports.startServer=startServer;