"use strict";var __extends=function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();exports.__esModule=!0;var config,SimpleRcon=require("simple-rcon"),Fs=require("fs"),Os=require("os"),ChildProcess=require("child_process"),Node_Console=require("console"),Path=require("path"),$=require("jquery"),swal=require("sweetalert"),DivConsole_1=require("./scripts/DivConsole"),config_1=require("@mcscriptstudiocode/config"),pluginmanager_1=require("@mcscriptstudiocode/pluginmanager"),divconsole=new DivConsole_1.DivConsole,tmp=__dirname+"/temp",Testserver=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.mcserver=null,e}return __extends(e,t),e.prototype.setup=function(e){(this.server=e).addElement(Fs.readFileSync(__dirname+"/console.html","utf8")),e.addStylesheet(__dirname+"/css/testserver.min.css"),Fs.existsSync(tmp)&&deleteFolderRecursive(tmp)},e.prototype.start=function(e){var r=this;this.server=e,config=new config_1.Config(__dirname+"/config.yml",config_1.FileFormatters.Yaml),loadConfig(),setupDrag(),divconsole.pipe(console.log),divconsole.pipe(document.getElementById("testservercontent")),Fs.existsSync(tmp)||Fs.mkdirSync(tmp);var n,t=e.getAPI("shortcutbar"),s=!1,o=this.mcserver;$("#testserverform").submit(function(e){e.preventDefault();var t=$("#testserverinput").val();return $("#testserverinput").val(""),s&&(divconsole.log("> "+t),o.execCommand(t,function(){})),!1}),t.addButton("start_testserver","testserver",'<i class="mdi mdi-server-plus"></i>',function(){if(s)deleteFolderRecursive(tmp+"/"+n+"/world/datapacks"),Fs.mkdirSync(tmp+"/"+n+"/world/datapacks"),walkSync(working_dir).forEach(function(e){"pack.mcmeta"==Path.basename(e).toLowerCase()&&Fs.readdirSync(Path.dirname(e)).includes("data")&&copyFolderRecursiveSync(Path.dirname(e),tmp+"/"+n+"/world/datapacks")}),r.mcserver.reload();else{var e=config.get("server.jar");if(!Fs.existsSync(e))return void swal("Jar not found","Please enter  valid jar into the Testserver config (point: server.jar)!","error");divconsole.log("starting server..."),$("#testserver").show(),s=!0,n=pluginmanager_1.guid(),Fs.mkdirSync(tmp+"/"+n),Fs.mkdirSync(tmp+"/"+n+"/world"),Fs.mkdirSync(tmp+"/"+n+"/world/datapacks"),Fs.writeFileSync(tmp+"/"+n+"/eula.txt","eula=true","utf8"),Fs.writeFileSync(tmp+"/"+n+"/server.properties","server-name=Testserver"+Os.EOL+"generator-settings=3;minecraft:bedrock,40*minecraft:stone,4*minecraft:dirt,minecraft:grass;1"+Os.EOL+"level-type=FLAT"+Os.EOL+"enable-command-block=true"+Os.EOL+"max-players=4"+Os.EOL+"server-port=25565"+Os.EOL+"debug=false"+Os.EOL+"enable-rcon=true"+Os.EOL+"rcon.port=25575"+Os.EOL+"rcon.password="+n+Os.EOL+"motd=§4MCScriptStudioCode §3Testserver§r","utf8"),walkSync(working_dir).forEach(function(e){"pack.mcmeta"==Path.basename(e).toLowerCase()&&Fs.readdirSync(Path.dirname(e)).includes("data")&&copyFolderRecursiveSync(Path.dirname(e),tmp+"/"+n+"/world/datapacks")});var t=new Server(e,tmp+"/"+n+"/",n);t.start(),r.mcserver=t,o=t}}),t.addButton("stop_testserver","stop testserver",'<i class="mdi mdi-server-minus"></i>',function(){$("#testserver").hide(),$("#testservercontent").empty(),$("#testserverinput").val(""),s&&(o.stop(),s=!1)}),$("#testserverreload").click(function(){s&&(deleteFolderRecursive(tmp+"/"+n+"/world/datapacks"),Fs.mkdirSync(tmp+"/"+n+"/world/datapacks"),walkSync(working_dir).forEach(function(e){"pack.mcmeta"==Path.basename(e).toLowerCase()&&Fs.readdirSync(Path.dirname(e)).includes("data")&&copyFolderRecursiveSync(Path.dirname(e),tmp+"/"+n+"/world/datapacks")}),r.mcserver.reload())});var i=!1;$("#testserverminimize").click(function(){i?($("#testservericons").children("i").show(),$("#testservername").show(),$("#testserverminimize").addClass("mdi-window-minimize"),$("#testserverminimize").removeClass("mdi-server"),$("#testserverform").show(),$("#testserver").animate({width:$(window).width()-300+"px",left:"-="+($(window).width()-300)+"px"},300,function(){$("#testserver").animate({height:"420px"},300,function(){i=!1})})):$("#testserver").animate({height:"19px"},300,function(){$("#testserver").animate({width:"19px",left:"+="+($(window).width()-300)+"px"},300,function(){$("#testservericons").children("i").not("#testserverminimize").hide(),$("#testservername").hide(),$("#testserverminimize").removeClass("mdi-window-minimize"),$("#testserverminimize").addClass("mdi-server"),$("#testserverform").hide(),i=!0})})}),$("#testserverstop").click(function(){$("#testserver").hide(),$("#testservercontent").empty(),$("#testserverinput").val(""),s&&(o.stop(),s=!1)}),Fs.watch(working_dir,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=!1;(e[1].endsWith(".mcfunction")||e[1].endsWith(".mcmeta")||e[1].endsWith(".json"))&&(r=!0),"rename"==e[0]&&(r=!0),config.get("autoreload")&&s&&r&&(deleteFolderRecursive(tmp+"/"+n+"/world/datapacks"),Fs.mkdirSync(tmp+"/"+n+"/world/datapacks"),walkSync(working_dir).forEach(function(e){"pack.mcmeta"==Path.basename(e).toLowerCase()&&Fs.readdirSync(Path.dirname(e)).includes("data")&&copyFolderRecursiveSync(Path.dirname(e),tmp+"/"+n+"/world/datapacks")}),o.reload())}),this.hasActiveServer=function(){return s}},e.prototype.stop=function(e){this.server=e,this.hasActiveServer()&&this.mcserver.stop(),Fs.existsSync(tmp)&&deleteFolderRecursive(tmp)},e.prototype.reload=function(e){this.server=e,null!=this.mcserver&&this.mcserver.stop(),Fs.existsSync(tmp)&&deleteFolderRecursive(tmp),Fs.existsSync(tmp)||Fs.mkdirSync(tmp)},e}(pluginmanager_1.Plugin);function deleteFolderRecursive(r){Fs.existsSync(r)&&(Fs.readdirSync(r).forEach(function(e){var t=r+"/"+e;Fs.lstatSync(t).isDirectory()?deleteFolderRecursive(t):Fs.unlinkSync(t)}),Fs.rmdirSync(r))}exports.default=Testserver;var Server=function(){function e(e,t,r){var n=this;this.working_dir=t,this.jar=e,this.password=r,process.on("exit",function(){return n.stop()})}return e.prototype.stop=function(){Node_Console.log("stopping...");var t=this.rcon;t.connect(),t.exec("stop",function(e){Node_Console.log(e),t.close()})},e.prototype.start=function(){var e=this;if(this.spawn)throw new Error("Server already started");var t=["-jar","-Xms"+config.get("server.minram"),"-Xmx"+config.get("server.maxram")];this.spawn=ChildProcess.exec(config.get("javacommand")+" "+t.join(" ")+" "+this.jar.replace(/\\/g,"/")+" "+["nogui"].join(" "),{cwd:this.working_dir}),this.spawn.stdout.pipe(process.stdout),this.spawn.stderr.pipe(process.stderr),this.spawn.stdout.pipe(divconsole.outStream),this.spawn.stderr.pipe(divconsole.errorStream),process.stdin.pipe(this.spawn.stdin),this.queue=[],this.rcon=new SimpleRcon({host:"localhost",port:25575,password:this.password,timeout:0}),this.rcon.on("authenticated",function(){Node_Console.log("rcon authenticated"),e.state="connected"}),this.rcon.on("disconnected",function(){Node_Console.log("rcon disconnected"),e.state="disconnected"}),this.rcon.on("error",function(e){Node_Console.error(e)})},e.prototype.reload=function(){var e=this.rcon;e.connect(),e.exec("reload",function(e){Node_Console.log(e)})},e.prototype.execCommand=function(e,t){void 0===t&&(t=function(e){Node_Console.log(e)});var r=this.rcon;r.connect(),r.exec(e,function(e){Node_Console.log(e)})},e}();function walkSync(t){t=t.replace(/\\/g,"/");var r=[];return Fs.lstatSync(t).isFile()?[t]:(Fs.readdirSync(t).forEach(function(e){r=r.concat(walkSync(t+"/"+e))}),r)}function copyFileSync(e,t){var r=t;Fs.existsSync(t)&&Fs.lstatSync(t).isDirectory()&&(r=Path.join(t,Path.basename(e))),Fs.writeFileSync(r,Fs.readFileSync(e))}function copyFolderRecursiveSync(r,e,t){void 0===t&&(t=!0);var n=e;t&&(n=Path.join(e,Path.basename(r))),Fs.existsSync(n)||Fs.mkdirSync(n),Fs.lstatSync(r).isDirectory()&&Fs.readdirSync(r).forEach(function(e){var t=Path.join(r,e);Fs.lstatSync(t).isDirectory()?copyFolderRecursiveSync(t,n):copyFileSync(t,n)})}function setupDrag(){!function(n){var s,o=0,i=0,c=0,a=0;document.getElementById(n.id+"header")?(s=document.getElementById(n.id+"header")).onmousedown=e:(s=n).onmousedown=e;function e(e){(e=e||window.event).preventDefault(),c=e.clientX,a=e.clientY,document.onmouseup=r,document.onmousemove=t}function t(e){(e=e||window.event).preventDefault(),o=c-e.clientX,i=a-e.clientY,c=e.clientX,a=e.clientY;var t=n.offsetLeft-o,r=n.offsetTop-i;t<1&&(t=1),r<1&&(r=1),t+$(n).width()>$(window).width()&&(t=$(window).width()-$(n).width()),r+2*$(s).height()>$(window).height()&&(r=$(window).height()-2*$(s).height()),n.style.left=t+"px",n.style.top=r+"px"}function r(){document.onmouseup=null,document.onmousemove=null}}(document.getElementById("testserver"))}function loadConfig(){config.load(),config.setStandart("autoreload",!0),config.setStandart("javacommand","java"),config.setStandart("server.jar","server.jar"),config.setStandart("server.maxram","2048M"),config.setStandart("server.minram","512M"),config.save()}