"use strict";exports.__esModule=!0;var pluginmanager_1=require("@mcscriptstudiocode/pluginmanager"),swal=require("sweetalert"),$=require("jquery"),fs=require("fs"),PATH=require("path"),CodeMirror=require("codemirror"),Highlights=function(){this.mcscript="mcscript",this.mcfunction="mcfunction",this.mcmeta="application/ld+json",this.json="application/ld+json",this.md="gfm",this.js="javascript",this.html="htmlmixed",this.yml="text/x-yaml"},Editor=function(){function e(){this.highlights=new Highlights,this.actual=void 0,this.opened={},this.texteditors=[];var t=this;$(window).keydown(function(e){if(e.ctrlKey)switch(e.key){case"s":e.preventDefault(),t.save();break;case"z":e.preventDefault(),t.undo();break;case"y":e.preventDefault(),t.redo();break;case"w":e.preventDefault(),t.closeActual()}})}return e.prototype.createEditor=function(e,t,r){return void 0===t&&(t="mcscript"),void 0===r&&(r="default"),e instanceof HTMLTextAreaElement?CodeMirror.fromTextArea(e,{mode:t,tabSize:2,lineNumbers:!0,firstLineNumber:1,extraKeys:{"Ctrl-Space":"autocomplete","Alt-F":"findPersistent","Ctrl-Q":function(e){e.foldCode(e.getCursor())}},lineWrapping:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","breakpoints","CodeMirror-foldgutter"],scrollbarStyle:"simple",theme:r}):CodeMirror.fromDiv(e,{mode:t,tabSize:2,lineNumbers:!0,firstLineNumber:1,extraKeys:{"Ctrl-Space":"autocomplete","Alt-F":"findPersistent","Ctrl-Q":function(e){e.foldCode(e.getCursor())}},lineWrapping:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","breakpoints","CodeMirror-foldgutter"],scrollbarStyle:"simple",theme:r})},e.prototype.getMode=function(e){return editor.highlights[e]?editor.highlights[e]:e},e.prototype.save=function(){editor.actual?editor.opened[editor.actual].save():swal("Nothing to save!","Sorry, but there is nothing to save, please select a file!","error")},e.prototype.undo=function(){editor.actual&&editor.opened[editor.actual].editor.undo()},e.prototype.redo=function(){editor.actual&&editor.opened[editor.actual].editor.redo()},e.prototype.closeActual=function(){editor.actual?editor.opened[editor.actual].close():swal("Nothing to close!","Sorry, but there is nothing to close!","error")},e.prototype.open=function(r){if(editor.opened[r])return!1;var e=fs.readFileSync(r).toString(),t=PATH.basename(r);$("#editorcontainer .CodeMirror").hide(),$("#editorcontainer .MineEditor").hide(),$("#editorfiles div.openedfile.selected").removeClass("selected"),$("#editorfiles #editorfilescontainer").append('<div class="openedfile selected" path="'+r+'"><p>'+t+'</p><i class="material-icons close">close</i></div>'),editor.actual=r;var i,o=createEditor(editor.getMode(r.match(/[^.]*$/)[0]),e),d=o.div,n=o.editor,a=o.type;o.save=function(){"code"==a?(fs.writeFileSync(r,n.getDoc().getValue()),editor.opened[r].content=n.getDoc().getValue(),i.removeClass("edited"),swal("Successfully saved!",'File successfully saved to "'+r+'"',"success")):"text"==a&&(fs.writeFileSync(r,$("#"+editor.opened[r].id).val()),editor.opened[r].content=$("#"+editor.opened[r].id).val(),i.removeClass("edited"),swal("Successfully saved!",'File successfully saved to "'+r+'"',"success"))};var s=$("div#editorfilescontainer div.selected");o.close=function(){var t=function(){return r==editor.actual&&(editor.actual=void 0),$(s).remove(),$(d).remove(),$("#"+editor.opened[r].id).remove(),reloadEditors(),editor.texteditors.includes(r)&&delete editor.texteditors[editor.texteditors.indexOf(r)],delete editor.opened[r],!1};$(this).parent().hasClass("edited")?swal({title:"Warning!",text:"editor file has unsaved edits. If you close it, the edits will be lost forever! Do you realy want to close it?",icon:"warning",buttons:{save:"Save",continue:"Save not",cancel:"Cancel"},dangerMode:!0}).then(function(e){"save"==e&&editor.opened[r].save(),"continue"==e&&t()}):t()},i=$("#editorfiles div.selected"),o.frame=i,editor.opened[r]=o,$("#editorfiles div.selected").click(function(){$("#editorfiles div.openedfile.selected").removeClass("selected"),$(this).addClass("selected"),editor.actual=r,$("#editorcontainer .CodeMirror").hide(),$("#editorcontainer .MineEditor").hide(),$(d).show()}).children("i.close").click(o.close),"code"==o.type?n.on("change",function(){editor.opened[r].content!=n.getDoc().getValue()?i.addClass("edited"):i.removeClass("edited")}):"text"==o.type&&editor.texteditors.push(r)},e}();function createEditor(e,t){if("htmlmixed"==e){var r=pluginmanager_1.guid();$("#editorcontainer").append('<textarea id="'+r+'" class="editor">'+t+"</textarea>"),reloadEditors();var i=document.getElementById(r);return{editor:i,id:r,content:t,type:"text",div:document.getElementById(i.getAttribute("editor"))}}var o=pluginmanager_1.guid();$("#editorcontainer").append('<textarea id="'+o+'">'+t+"</textarea>");var d=CodeMirror.fromTextArea(document.getElementById(o),{mode:e,tabSize:2,lineNumbers:!0,firstLineNumber:1,extraKeys:{"Ctrl-Space":"autocomplete","Alt-F":"findPersistent",F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)},"Ctrl-Q":function(e){e.foldCode(e.getCursor())}},lineWrapping:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","breakpoints","CodeMirror-foldgutter"],scrollbarStyle:"simple",theme:"mtheme"});d.on("gutterClick",function(e,t){var r,i=e.lineInfo(t);e.setGutterMarker(t,"breakpoints",i.gutterMarkers?null:((r=document.createElement("div")).style.color="#822",r.innerHTML='<font color="red">&bull;</font>',r))});var n=pluginmanager_1.guid();return $("#editorcontainer .CodeMirror").not(".hasid").attr("id",n),$("#editorcontainer .CodeMirror").not(".hasid").addClass("hasid"),$("#id").remove(),t=d.getDoc().getValue(),{editor:d,id:o,div:document.getElementById(n),content:t,type:"code"}}exports.Editor=Editor,setInterval(function(){if(editor.actual)for(var e=0,t=editor.texteditors;e<t.length;e++){var r=t[e];editor.opened[r].content!=$("#"+editor.opened[r].id).val()?editor.opened[r].frame.addClass("edited"):editor.opened[r].frame.removeClass("edited")}},1),$(document).ready(function(){setInterval(function(){$("#editorcontainer .MineEditor .MineEditor-canvas").each(function(){$(this).height($(this).parent().height()-$(this).parent().children(".MineEditor-menuebar").height()-$(this).parent().children(".MineEditor-bottom").height()-44)})},10),$("#editorcontainer .CodeMirror").hide(),$("#editorcontainer .MineEditor").hide()});var editor=new Editor;exports.editor=editor,exports.default=editor;