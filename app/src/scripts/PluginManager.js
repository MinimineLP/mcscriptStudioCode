"use strict";var __awaiter=function(s,o,c,u){return new(c||(c=Promise))(function(e,n){function t(e){try{r(u.next(e))}catch(e){n(e)}}function i(e){try{r(u.throw(e))}catch(e){n(e)}}function r(n){n.done?e(n.value):new c(function(e){e(n.value)}).then(t,i)}r((u=u.apply(s,o||[])).next())})},__generator=function(t,i){var r,s,o,e,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,s&&(o=2&n[0]?s.return:n[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,n[1])).done)return o;switch(s=0,o&&(n=[2&n[0],o.value]),n[0]){case 0:case 1:o=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,s=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(!(o=0<(o=c.trys).length&&o[o.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){c.label=n[1];break}if(6===n[0]&&c.label<o[1]){c.label=o[1],o=n;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(n);break}o[2]&&c.ops.pop(),c.trys.pop();continue}n=i.call(t,c)}catch(e){n=[6,e],s=0}finally{r=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}};exports.__esModule=!0;var manager,fs=require("fs"),Path=require("path"),extract=require("extract-zip"),$=require("jquery"),npmi=require("npmi"),SiteAPI=require("./SiteApi");global.srclocation=__dirname;var PluginManager=function(){function e(){(e.instance=this).plugins=[],this.api=new ServerApi(this),manager=this}return e.prototype.readyPluginDir=function(e){fs.existsSync(e+"/node_modules")||fs.mkdirSync(e+"/node_modules"),fs.existsSync(e+"/node_modules/@mcscriptstudiocode")&&deleteFolderRecursive(e+"/node_modules/@mcscriptstudiocode"),copyFolderRecursiveSync("types/@mcscriptstudiocode",e+"/node_modules"),fs.existsSync(e+"/node_modules/mcscriptstudiocode")&&deleteFolderRecursive(e+"/node_modules/mcscriptstudiocode"),copyFolderRecursiveSync("types/mcscriptstudiocode",e+"/node_modules"),fs.existsSync(e+"/node_modules/@mcscriptstudiocodeplugins")&&deleteFolderRecursive(e+"/node_modules/@mcscriptstudiocodeplugins"),fs.mkdirSync(e+"/node_modules/@mcscriptstudiocodeplugins")},e.prototype.readyPlugin=function(i,r,s){return void 0===s&&(s=function(){}),__awaiter(this,void 0,void 0,function(){var n,t;return __generator(this,function(e){try{if(fs.existsSync(i+"/"+r+"/types")&&(n=i+"/node_modules",fs.existsSync(n)||fs.mkdirSync(n),fs.existsSync(n+"/@mcscriptstudiocodeplugins")||fs.mkdirSync(n+"/@mcscriptstudiocodeplugins"),t=n+"/@mcscriptstudiocodeplugins/"+r,fs.existsSync(t)&&deleteFolderRecursive(t),fs.mkdirSync(t),copyFolderRecursiveSync(i+"/"+r+"/types",t,!1)),!fs.existsSync(i+"/"+r))return[2];npmi({path:i+"/"+r,forceInstall:!1,npmLoad:{loglevel:"silent",production:"true"}},function(e){if(e)return s&&s(e),e.code===npmi.LOAD_ERR?console.log("npm load error"):e.code===npmi.INSTALL_ERR&&console.log("npm install error"),console.log(e.message);s&&s()})}catch(e){s(e),e.printStackTrace()}return[2]})})},e.prototype.loadPlugins=function(i,r){void 0===r&&(r=function(){});var s=this;s.readyPluginDir(i),fs.existsSync(i)||fs.mkdirSync(i);var o=this.getPlugins(i),c=[];o.forEach(function(e,t){c[t]=!1,s.readyPlugin(i,e,function(){var n=c[t]=!0;c.forEach(function(e){e||(n=!1)}),n&&(o.forEach(function(e){s.plugins.push(s.loadPlugin(i,e))}),r&&r())})})},e.prototype.loadPlugin=function(e,n){if(!fs.existsSync(e+"/"+n+"/"))throw new Error("Plugin "+n+" does not exists in plugindir "+e);if(fs.existsSync(e+"/"+n+"/types")){var t=e+"/node_modules";fs.existsSync(t)||fs.mkdirSync(t),fs.existsSync(t+"/@mcscriptstudiocodeplugins")||fs.mkdirSync(t+"/@mcscriptstudiocodeplugins");var i=t+"/@mcscriptstudiocodeplugins/"+n;fs.existsSync(i)&&deleteFolderRecursive(i),fs.mkdirSync(i),copyFolderRecursiveSync(e+"/"+n+"/types",i,!1)}var r=this.getPluginDescription(e,n),s=r.name,o=r.url,c=r.author,u=r.author_url,l=r.version,a=r.main,p=[];if(r.pluginDependencies)for(var d in r.pluginDependencies){fs.existsSync(e+"/"+r.pluginDependencies[d].name)||(console.log("installing plugin "+r.pluginDependencies[d].name+' from "'+r.pluginDependencies[d].url+'" caused of a dependency of plugin "'+s+'"'),this.installPlugin(r.pluginDependencies[d].url,e));var f=new Dependency(r.pluginDependencies[d].name,r.pluginDependencies[d].url,e,s);p.push(f)}if(!fs.existsSync(e+"/"+n+"/"+a))throw new Error("Plugin main from plugin "+n+" does not exists");return new(require(e+"/"+n+"/"+a).default)(s,o,c,u,l,a,p,e+"/"+n)},e.prototype.setupPlugins=function(){for(var e=0,n=this.plugins;e<n.length;e++){n[e].setup(this.api)}},e.prototype.startPlugins=function(){for(var e=0,n=this.plugins;e<n.length;e++){n[e].start(this.api)}},e.prototype.stopPlugins=function(){for(var e=0,n=this.plugins;e<n.length;e++){n[e].stop(this.api)}},e.prototype.reloadPlugins=function(){for(var e=0,n=this.plugins;e<n.length;e++){n[e].reload(this.api)}},e.prototype.getPluginDescription=function(e,n){try{return JSON.parse(fs.readFileSync(e+"/"+n+"/package.json").toString())}catch(e){return console.error("Error reading plugindescription of plugin "+n+": ",e),{}}},e.prototype.getPlugins=function(e){for(var n=[],t=0,i=fs.readdirSync(e);t<i.length;t++){var r=i[t];fs.lstatSync(e+"/"+r).isDirectory()&&"node_modules"!=r.toLowerCase()&&n.push(r)}return n},e.prototype.fireEvent=function(e){return this.api.fireEvent(e)},e.prototype.installPlugin=function(e,i){var r=this;SiteAPI.loadSite(SiteAPI.parseURL(e),function(n){if(n=JSON.parse(n),!fs.existsSync(i+"/"+n.name)){var t=i+"/"+n.name+".tmp.zip";SiteAPI.downloadFile(t,n.versions[n.newestversion],function(){extract(t,{dir:i+"/"+n.name},function(e){e?console.log(e):(fs.unlinkSync(t),r.readyPlugin(i,n.name))})})}})},e}();exports.PluginManager=PluginManager;var ServerApi=function(){function e(e){this.listeners=[],this.apis={},this.manager=e,this.plugins=e.plugins}return e.prototype.on=function(e,n){this.registerListener(new OnListener(e,n))},e.prototype.registerListener=function(e){this.listeners.push(e)},e.prototype.fireEvent=function(e){for(var n=e.getType(),t=0,i=this.listeners;t<i.length;t++){var r=i[t];r.getType()==n&&r.run(e)}return e},e.prototype.addStylesheet=function(e){if(!document.getElementById(e)){var n=document.getElementsByTagName("head")[0],t=document.createElement("link");t.id=e,t.rel="stylesheet",t.type="text/css",t.href=e,t.media="all",n.appendChild(t)}},e.prototype.addScript=function(e){if(console.warn("Please use require(yourscript) instead of the deprecated method ServerApi#addScript()"),!document.getElementById(e)){var n=document.getElementsByTagName("head")[0],t=document.createElement("script");t.id=e,t.type="text/javascript",t.src=e,n.appendChild(t)}},e.prototype.addElement=function(e){e instanceof HTMLElement?document.body.appendChild(e):$("body").append(e)},e.prototype.registerAPI=function(e,n){this.apis[e]=n},e.prototype.getAPI=function(e){return this.apis[e]},e}();exports.ServerApi=ServerApi;var Plugin=function(e,n,t,i,r,s,o,c){this.name=e,this.url=n,this.author=t,this.author_url=i,this.version=r,this.main=s,this.dependencies=o,this.path=c};exports.Plugin=Plugin;var Dependency=function(e,n,t,i){if(this.name=e,this.url=n,fs.existsSync(t+"/"+e+"/")||manager.installPlugin(n,t),!fs.existsSync(t+"/"+e+"/"))throw new Error("The dependency "+e+" in "+i+" has an wrong import!");this.plugin=manager.loadPlugin(t,e)},OnListener=function(){function e(e,n){this.trigger=e,this.func=n}return e.prototype.run=function(e){this.func(e)},e.prototype.getType=function(){return this.trigger},e}();function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function copyFileSync(e,n){var t=n;fs.existsSync(n)&&fs.lstatSync(n).isDirectory()&&(t=Path.join(n,Path.basename(e))),fs.writeFileSync(t,fs.readFileSync(e))}function copyFolderRecursiveSync(t,e,n){void 0===n&&(n=!0);var i=e;n&&(i=Path.join(e,Path.basename(t))),fs.existsSync(i)||fs.mkdirSync(i),fs.lstatSync(t).isDirectory()&&fs.readdirSync(t).forEach(function(e){var n=Path.join(t,e);fs.lstatSync(n).isDirectory()?copyFolderRecursiveSync(n,i):copyFileSync(n,i)})}function deleteFolderRecursive(t){fs.existsSync(t)&&(fs.readdirSync(t).forEach(function(e){var n=t+"/"+e;fs.lstatSync(n).isDirectory()?deleteFolderRecursive(n):fs.unlinkSync(n)}),fs.rmdirSync(t))}exports.OnListener=OnListener,exports.guid=guid,global.Plugin=Plugin,global.ServerApi=ServerApi,global.PluginManager=PluginManager,global.Event=Event,global.OnListener=OnListener,global.guid=guid,global.deleteFolderRecursive=deleteFolderRecursive,global.copyFolderRecursiveSync=copyFolderRecursiveSync,global.copyFileSync=copyFileSync,exports.default=PluginManager;